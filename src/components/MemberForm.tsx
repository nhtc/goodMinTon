"use client"
import { withAuth } from "@/components/AuthorizedComponent"
import React, { useState, useEffect, useRef } from "react"
import styles from "./MemberForm.module.css"

interface Member {
  id: string
  name: string
  email?: string
  phone?: string
  isActive: boolean
  createdAt: string
}

interface MemberFormProps {
  onUpdate: (updatedMember?: Member) => void
  editingMember?: Member | null
}

const MemberForm: React.FC<MemberFormProps> = ({ onUpdate, editingMember }) => {
  const [name, setName] = useState(editingMember?.name || "")
  const [phone, setPhone] = useState(editingMember?.phone || "")
  const [isActive, setIsActive] = useState(editingMember?.isActive ?? true)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [isCheckingName, setIsCheckingName] = useState(false)
  const [error, setError] = useState("")
  const [success, setSuccess] = useState("")
  const [nameExists, setNameExists] = useState(false)
  const [phoneError, setPhoneError] = useState("")
  const isEditing = !!editingMember

  // Use useRef to store the timeout ID
  const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null)

  // Vietnamese phone number validation
  const validateVietnamesePhone = (
    phoneNumber: string
  ): { isValid: boolean; message: string } => {
    if (!phoneNumber.trim()) {
      return { isValid: true, message: "" } // Phone is optional
    }

    // Remove all non-digit characters
    const cleanPhone = phoneNumber.replace(/\D/g, "")

    // Vietnamese phone number patterns
    const patterns = [
      /^(84|0)(3[2-9]|5[689]|7[06-9]|8[1-9]|9[0-9])\d{7}$/, // Mobile numbers
      /^(84|0)(2[0-9])\d{8}$/, // Landline numbers (area code 2X)
      /^(84|0)(2[0-9])\d{7}$/, // Some landline numbers (shorter)
    ]

    const isValid = patterns.some(pattern => pattern.test(cleanPhone))

    if (!isValid) {
      if (cleanPhone.length < 9) {
        return { isValid: false, message: "S·ªë ƒëi·ªán tho·∫°i qu√° ng·∫Øn" }
      } else if (cleanPhone.length > 11) {
        return { isValid: false, message: "S·ªë ƒëi·ªán tho·∫°i qu√° d√†i" }
      } else if (!cleanPhone.startsWith("84") && !cleanPhone.startsWith("0")) {
        return {
          isValid: false,
          message: "S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 ho·∫∑c 84",
        }
      } else {
        return { isValid: false, message: "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá" }
      }
    }

    return { isValid: true, message: "S·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá" }
  }

  // Populate form when editing
  useEffect(() => {
    if (editingMember) {
      setName(editingMember.name)
      setPhone(editingMember.phone || "")
      setIsActive(editingMember.isActive ?? true)
      setError("")
      setSuccess("")
      setNameExists(false)
      setPhoneError("")
    }
  }, [editingMember])

  // Handle phone number changes with validation
  const handlePhoneChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value
    setPhone(value)

    // Clear general error when user starts typing
    if (error && error.includes("ƒëi·ªán tho·∫°i")) {
      setError("")
    }

    // Validate phone number
    const validation = validateVietnamesePhone(value)
    setPhoneError(validation.isValid ? "" : validation.message)
  }

  // Check if name exists as user types
  const checkNameExists = async (nameValue: string) => {
    if (nameValue.trim().length < 2) return
    setIsCheckingName(true)
    try {
      const response = await fetch(
        `/api/members/check-name?name=${encodeURIComponent(nameValue.trim())}`
      )
      const data = await response.json()
      setNameExists(data.exists)
    } catch (error) {
      console.error("Error checking name:", error)
    } finally {
      setIsCheckingName(false)
    }
  }

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value
    setName(value)
    setNameExists(false)

    // Clear error when user starts typing
    if (error && value.trim()) {
      setError("")
    }

    // Clear previous timeout
    if (debounceTimeoutRef.current) {
      clearTimeout(debounceTimeoutRef.current)
    }

    // Set new timeout for debounced name checking
    if (value.trim().length >= 2) {
      setIsCheckingName?.(true)
      debounceTimeoutRef.current = setTimeout(() => {
        checkNameExists(value)
      }, 800) // 800ms delay
    } else {
      // If name is too short, reset states
      setIsCheckingName(false)
      setNameExists(false)
    }
  }

  // Cleanup timeout on component unmount
  useEffect(() => {
    return () => {
      if (debounceTimeoutRef.current) {
        clearTimeout(debounceTimeoutRef.current)
      }
    }
  }, [])

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)
    setError("")
    setSuccess("")

    // Clear any pending name check
    if (debounceTimeoutRef.current) {
      clearTimeout(debounceTimeoutRef.current)
    }

    // Basic validation
    if (!name.trim()) {
      setError("T√™n th√†nh vi√™n l√† b·∫Øt bu·ªôc")
      setIsSubmitting(false)
      return
    }

    if (name.trim().length < 2) {
      setError("T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±")
      setIsSubmitting(false)
      return
    }

    // Final check for name existence before submitting (skip for editing with same name)
    if (isCheckingName) {
      setError("Vui l√≤ng ƒë·ª£i ki·ªÉm tra t√™n ho√†n t·∫•t")
      setIsSubmitting(false)
      return
    }

    if (nameExists && (!isEditing || name.trim() !== editingMember?.name)) {
      setError("T√™n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Vui l√≤ng ch·ªçn t√™n kh√°c.")
      setIsSubmitting(false)
      return
    }

    // Validate phone number if provided
    if (phone.trim()) {
      const phoneValidation = validateVietnamesePhone(phone.trim())
      if (!phoneValidation.isValid) {
        setError(`S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá: ${phoneValidation.message}`)
        setIsSubmitting(false)
        return
      }
    }

    try {
      const url = isEditing
        ? `/api/members/${editingMember!.id}`
        : "/api/members"
      const method = isEditing ? "PUT" : "POST"

      const response = await fetch(url, {
        method,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          name: name.trim(),
          phone: phone.trim() || undefined,
          isActive,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(
          data.error || `Failed to ${isEditing ? "update" : "create"} member`
        )
      }

      // Success
      if (!isEditing) {
        setName("")
        setPhone("")
        setIsActive(true)
        setNameExists(false)
      }
      setSuccess(
        isEditing
          ? "üéâ C·∫≠p nh·∫≠t th√†nh vi√™n th√†nh c√¥ng!"
          : "üéâ Th√™m th√†nh vi√™n th√†nh c√¥ng!"
      )
      
      // Pass the updated/created member data back to parent
      onUpdate(data)

      setTimeout(() => setSuccess(""), 4000)
    } catch (error) {
      console.error(
        `Error ${isEditing ? "updating" : "creating"} member:`,
        error
      )
      setError(
        error instanceof Error
          ? error.message
          : `Kh√¥ng th·ªÉ ${
              isEditing ? "c·∫≠p nh·∫≠t" : "th√™m"
            } th√†nh vi√™n. Vui l√≤ng th·ª≠ l·∫°i!`
      )
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div className={styles.memberFormContainer}>
      {/* Form Header */}
      <div className={styles.formHeader}>
        <div className={styles.headerIconWrapper}>
          <div className={styles.headerIcon}>
            <span>üë§</span>
          </div>
          <div className={styles.iconPulse}></div>
        </div>
        <div className={styles.headerContent}>
          <h2 className={styles.formTitle}>
            {isEditing ? "Ch·ªânh S·ª≠a Th√†nh Vi√™n" : "Th√™m Th√†nh vi√™n M·ªõi"}
          </h2>
          <p className={styles.formSubtitle}>
            {isEditing
              ? "C·∫≠p nh·∫≠t th√¥ng tin th√†nh vi√™n c√¢u l·∫°c b·ªô c·∫ßu l√¥ng"
              : "M·ªùi th√™m th√†nh vi√™n m·ªõi v√†o c√¢u l·∫°c b·ªô c·∫ßu l√¥ng c·ªßa b·∫°n"}
          </p>
        </div>
      </div>

      {/* Success Message */}
      {success && (
        <div className={`${styles.alert} ${styles.successAlert}`}>
          <div className={styles.alertIcon}>‚úÖ</div>
          <div className={styles.alertContent}>
            <div className={styles.alertTitle}>Th√†nh c√¥ng!</div>
            <div className={styles.alertMessage}>{success}</div>
          </div>
          <div className={styles.alertProgress}></div>
        </div>
      )}

      {/* Error Message */}
      {error && (
        <div className={`${styles.alert} ${styles.errorAlert}`}>
          <div className={styles.alertIcon}>‚ö†Ô∏è</div>
          <div className={styles.alertContent}>
            <div className={styles.alertTitle}>C√≥ l·ªói x·∫£y ra</div>
            <div className={styles.alertMessage}>{error}</div>
          </div>
          <button onClick={() => setError("")} className={styles.alertClose}>
            ‚úï
          </button>
        </div>
      )}

      {/* Form */}
      <form onSubmit={handleSubmit} className={styles.memberForm}>
        <div className={styles.formFields}>
          {/* Name Field */}
          <div className={styles.fieldGroup}>
            <label htmlFor='name' className={styles.fieldLabel}>
              <span className={styles.labelIcon}>üë§</span>
              <span className={styles.labelText}>T√™n ƒë·∫ßy ƒë·ªß</span>
              <span className={styles.requiredStar}>*</span>
            </label>
            <div className={styles.inputWrapper}>
              <input
                type='text'
                id='name'
                value={name}
                onChange={handleNameChange}
                required
                className={`${styles.formInput} ${
                  error && !name.trim() ? styles.error : ""
                } ${nameExists ? styles.error : ""} ${
                  name.trim() && !nameExists && !isCheckingName
                    ? styles.filled
                    : ""
                }`}
                placeholder='Nh·∫≠p t√™n th√†nh vi√™n (ph·∫£i duy nh·∫•t)...'
                disabled={isSubmitting}
                maxLength={50}
              />
              <div className={styles.inputBorder}></div>

              {/* Input status icons */}
              {isCheckingName && (
                <div className={`${styles.inputIcon} ${styles.checking}`}>
                  <div className={styles.miniSpinner}></div>
                </div>
              )}

              {!isCheckingName && nameExists && (
                <div className={`${styles.inputIcon} ${styles.error}`}>
                  <span>‚úï</span>
                </div>
              )}

              {!isCheckingName && name.trim().length >= 2 && !nameExists && (
                <div className={`${styles.inputIcon} ${styles.success}`}>
                  <span>‚úì</span>
                </div>
              )}
            </div>

            {/* Field help messages */}
            {nameExists && !isCheckingName && (
              <div className={`${styles.fieldHelp} ${styles.error}`}>
                <span>‚ùå T√™n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng</span>
              </div>
            )}

            {name.trim().length >= 2 && !nameExists && !isCheckingName && (
              <div className={`${styles.fieldHelp} ${styles.success}`}>
                <span>‚úì T√™n kh·∫£ d·ª•ng</span>
              </div>
            )}

            {isCheckingName && (
              <div className={`${styles.fieldHelp} ${styles.checking}`}>
                <span>üîç ƒêang ki·ªÉm tra t√™n...</span>
              </div>
            )}

            {name.trim().length > 0 && name.trim().length < 2 && (
              <div className={`${styles.fieldHelp} ${styles.warning}`}>
                <span>‚ö†Ô∏è T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±</span>
              </div>
            )}
          </div>

          {/* Phone Field */}
          <div className={styles.fieldGroup}>
            <label htmlFor='phone' className={styles.fieldLabel}>
              <span className={styles.labelIcon}>üì±</span>
              <span className={styles.labelText}>S·ªë ƒëi·ªán tho·∫°i</span>
              <span className={styles.optionalText}>(kh√¥ng b·∫Øt bu·ªôc)</span>
            </label>
            <div className={styles.inputWrapper}>
              <input
                type='tel'
                id='phone'
                value={phone}
                onChange={handlePhoneChange}
                className={`${styles.formInput} ${
                  phoneError ? styles.error : ""
                } ${phone.trim() && !phoneError ? styles.filled : ""}`}
                placeholder='VD: 0912345678 ho·∫∑c 84912345678'
                disabled={isSubmitting}
                maxLength={15}
              />
              <div className={styles.inputBorder}></div>

              {/* Phone validation icons */}
              {phoneError && (
                <div className={`${styles.inputIcon} ${styles.error}`}>
                  <span>‚úï</span>
                </div>
              )}

              {phone.trim() && !phoneError && (
                <div className={`${styles.inputIcon} ${styles.success}`}>
                  <span>‚úì</span>
                </div>
              )}
            </div>

            {/* Phone validation messages */}
            {phoneError && (
              <div className={`${styles.fieldHelp} ${styles.error}`}>
                <span>‚ùå {phoneError}</span>
              </div>
            )}

            {phone.trim() && !phoneError && (
              <div className={`${styles.fieldHelp} ${styles.success}`}>
                <span>‚úì S·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá</span>
              </div>
            )}

            {!phone.trim() && (
              <div className={styles.fieldHelp}>
                <span>üí° VD: 0912345678, +84912345678, 02812345678</span>
              </div>
            )}
          </div>

          {/* Active Status Field */}
          <div className={styles.fieldGroup}>
            <label className={`${styles.fieldLabel} ${styles.friendly}`}>
              <span className={styles.labelIcon}>
                {isActive ? "‚úÖ" : "‚è∏Ô∏è"}
              </span>
              <span className={styles.labelText}>Tr·∫°ng th√°i th√†nh vi√™n</span>
            </label>
            <div className={styles.statusToggleWrapper}>
              <label className={styles.statusToggle}>
                <input
                  type="checkbox"
                  checked={isActive}
                  onChange={(e) => setIsActive(e.target.checked)}
                  className={styles.statusCheckbox}
                  disabled={isSubmitting}
                />
                <span className={styles.statusSlider}></span>
                <span className={styles.statusLabel}>
                  {isActive ? "ƒêang ho·∫°t ƒë·ªông" : "T·∫°m d·ª´ng"}
                </span>
              </label>
            </div>
            <div className={styles.fieldHelp}>
              <span>
                üí° {isActive 
                  ? "Th√†nh vi√™n s·∫Ω xu·∫•t hi·ªán trong danh s√°ch ch·ªçn khi t·∫°o tr·∫≠n ƒë·∫•u"
                  : "Th√†nh vi√™n s·∫Ω kh√¥ng xu·∫•t hi·ªán khi t·∫°o tr·∫≠n ƒë·∫•u m·ªõi"
                }
              </span>
            </div>
          </div>
        </div>

        {/* Submit Button */}
        <div className={styles.formActions}>
          <button
            type='submit'
            disabled={
              isSubmitting ||
              !name.trim() ||
              name.trim().length < 2 ||
              nameExists ||
              isCheckingName ||
              phoneError !== ""
            }
            className={`${styles.submitBtn} ${
              isSubmitting ? styles.loading : ""
            } ${
              !name.trim() ||
              name.trim().length < 2 ||
              nameExists ||
              isCheckingName ||
              phoneError !== ""
                ? styles.disabled
                : ""
            }`}
          >
            <span className={styles.btnContent}>
              {isSubmitting ? (
                <>
                  <div className={styles.btnSpinner}></div>
                  <span>
                    {isEditing ? "ƒêang c·∫≠p nh·∫≠t..." : "ƒêang th√™m th√†nh vi√™n..."}
                  </span>
                </>
              ) : (
                <>
                  <span className={styles.btnIcon}>
                    {isEditing ? "‚úèÔ∏è" : "‚ûï"}
                  </span>
                  <span>
                    {isEditing ? "C·∫≠p nh·∫≠t th√†nh vi√™n" : "Th√™m th√†nh vi√™n"}
                  </span>
                </>
              )}
            </span>
            <div className={styles.btnShine}></div>
          </button>

          {/* Form Tips */}
          <div className={styles.formTips}>
            <div className={styles.tipItem}>
              <span className={styles.tipIcon}>‚ö†Ô∏è</span>
              <span>T√™n ph·∫£i duy nh·∫•t trong h·ªá th·ªëng</span>
            </div>
            <div className={styles.tipItem}>
              <span className={styles.tipIcon}>üîç</span>
              <span>H·ªá th·ªëng s·∫Ω ki·ªÉm tra t√™n t·ª± ƒë·ªông</span>
            </div>
            <div className={styles.tipItem}>
              <span className={styles.tipIcon}>ÔøΩ</span>
              <span>S·ªë ƒëi·ªán tho·∫°i h·ªó tr·ª£ ƒë·ªãnh d·∫°ng Vi·ªát Nam</span>
            </div>
            <div className={styles.tipItem}>
              <span className={styles.tipIcon}>ÔøΩüîí</span>
              <span>Th√¥ng tin c·ªßa b·∫°n ƒë∆∞·ª£c b·∫£o m·∫≠t tuy·ªát ƒë·ªëi</span>
            </div>
          </div>
        </div>
      </form>
    </div>
  )
}

export default withAuth(MemberForm)
